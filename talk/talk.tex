\documentclass{beamer}
\usepackage{tikz}
\usepackage[style=authoryear]{biblatex}
\usepackage{empheq}

\usetikzlibrary{arrows}
\usetikzlibrary{calc}
\usetikzlibrary{decorations.pathreplacing}
\usetikzlibrary{positioning}
\usetikzlibrary{shapes}
\tikzstyle{every picture}+=[remember picture]


\usetheme{Singapore}
\usecolortheme{lily}
\beamertemplatenavigationsymbolsempty

\DeclareMathOperator{\ifff}{:-}
\DeclareMathOperator{\prob}{::}

\definecolor{predicate}{HTML}{1b9e77}
\definecolor{probability}{HTML}{e7298a}
\definecolor{variable}{HTML}{d95f02}
\definecolor{constant}{HTML}{7570b3}
\definecolor{color5}{HTML}{66a61e}
\definecolor{color6}{HTML}{e6ab02}

\addbibresource{talk.bib}

\author{\textbf{Paulius Dilkas}\inst{1} \and Vaishak Belle\inst{1,2}}
\title{Generating Random Logic Programs Using Constraint Programming}
\date{CP 2020}
\institute{\inst{1} University of Edinburgh, Edinburgh, UK \and \inst{2} Alan
  Turing Institute, London, UK}

\begin{document}

\begin{frame}[noframenumbering,plain]
  \tikz[remember picture,overlay]{
    \node at ([yshift=25pt,xshift=30pt]current page.south)
    {\includegraphics[height=40pt]{inf.png}};
    \node at ([yshift=25pt,xshift=75pt]current page.south)
    {\includegraphics[height=40pt]{ecr.jpg}};
    \node at ([yshift=20pt,xshift=140pt]current page.south)
    {\includegraphics[height=20pt]{epsrc.png}};
  }
  \titlepage
\end{frame}

% width: 4.2679148611112
% height: 3.5575922222223

\begin{frame}{Probabilistic Logic Programs (\textsc{ProbLog})}
  \begin{block}{The Smokers Network (\cite{DBLP:conf/ilp/DomingosKLPRS08})}
    \vspace*{-\baselineskip}\setlength\belowdisplayshortskip{0pt}
    \begin{align*}
      \textcolor{probability}{0.2} \prob &\textcolor{predicate}{\mathtt{stress}}(\textcolor{variable}{\mathsf{P}}) \ifff \textcolor{predicate}{\mathtt{person}}(\textcolor{variable}{\mathsf{P}}). \\
      \textcolor{probability}{0.3} \prob &\textcolor{predicate}{\mathtt{influences}}(\textcolor{variable}{\mathsf{P}_1}, \textcolor{variable}{\mathsf{P}_2}) \ifff \textcolor{predicate}{\mathtt{friend}}(\textcolor{variable}{\mathsf{P}_1}, \textcolor{variable}{\mathsf{P}_2}). \\
      \textcolor{probability}{0.1} \prob &\textcolor{predicate}{\mathtt{cancer\_spont}}(\textcolor{variable}{\mathsf{P}}) \ifff \textcolor{predicate}{\mathtt{person}}(\textcolor{variable}{\mathsf{P}}). \\
      \textcolor{probability}{0.3} \prob &\textcolor{predicate}{\mathtt{cancer\_smoke}}(\textcolor{variable}{\mathsf{P}}) \ifff \textcolor{predicate}{\mathtt{person}}(\textcolor{variable}{\mathsf{P}}). \\
                                         &\textcolor{predicate}{\mathtt{smokes}}(\textcolor{variable}{\mathsf{X}}) \ifff \textcolor{predicate}{\mathtt{stress}}(\textcolor{variable}{\mathsf{X}}). \\
                                         &\textcolor{predicate}{\mathtt{smokes}}(\textcolor{variable}{\mathsf{X}}) \ifff \textcolor{predicate}{\mathtt{smokes}}(\textcolor{variable}{\mathsf{Y}}), \textcolor{predicate}{\mathtt{influences}}(\textcolor{variable}{\mathsf{Y}}, \textcolor{variable}{\mathsf{X}}). \\
                                         &\textcolor{predicate}{\mathtt{cancer}}(\textcolor{variable}{\mathsf{P}}) \ifff \textcolor{predicate}{\mathtt{cancer\_spont}}(\textcolor{variable}{\mathsf{P}}). \\
                                         &\textcolor{predicate}{\mathtt{cancer}}(\textcolor{variable}{\mathsf{P}}) \ifff \textcolor{predicate}{\mathtt{smokes}}(\textcolor{variable}{\mathsf{P}}), \textcolor{predicate}{\mathtt{cancer\_smoke}}(\textcolor{variable}{\mathsf{P}}). \\
                                         &\textcolor{predicate}{\mathtt{person}}(\textcolor{constant}{\mathit{michelle}}). \\
                                         &\textcolor{predicate}{\mathtt{person}}(\textcolor{constant}{\mathit{timothy}}). \\
                                         &\textcolor{predicate}{\mathtt{friend}}(\textcolor{constant}{\mathit{timothy}}, \textcolor{constant}{\mathit{michelle}}).
    \end{align*}
  \end{block}
\end{frame}

\begin{frame}{Applications}
  \begin{columns}[b]
    \begin{column}{0.5\textwidth}
      \includegraphics[width=\textwidth]{application1.png}
      {\small \cite{DBLP:conf/icra/MoldovanMOSR12}}
    \end{column}
    \begin{column}{0.5\textwidth}
      \includegraphics[width=\textwidth]{application3.png}
      {\small \cite{DBLP:conf/ijcai/DriesKDBR17}}
    \end{column}
  \end{columns}
  \vfill
  \begin{columns}[b]
    \begin{column}{0.5\textwidth}
      \includegraphics[width=\textwidth]{application2.png}
      {\small \cite{DBLP:conf/ilp/Corte-RealD017}}
    \end{column}
    \begin{column}{0.5\textwidth}
      \includegraphics[width=\textwidth]{application4.png}
      {\small \cite{de2013phenetic}}
    \end{column}
  \end{columns}
\end{frame}

% TODO: finish the explanation
\begin{frame}{Inference Algorithms and Knowledge Compilation Maps}
  \begin{description}
  \item[NNF] negation normal form
  \item[d-DNNF] deterministic decomposable negation normal form
  \item[BDD] binary decision diagrams
  \item[SDD] sentential decision diagrams
  \item[$k$-Best] ???
  \end{description}
\end{frame}

\begin{frame}{Example Diagrams for $C \land (A \lor \neg B)$}
  \vspace{-1em}
  % \begin{tikzpicture}
  %   \node[draw,circle] {$\land$}
  %   child {node[draw,rectangle] {$C$}}
  %   child {node[draw,circle] {$\lor$}
  %     child {node[draw,rectangle] {$A$}}
  %     child {node[draw,rectangle] {$\neg B$}
  %     }
  %   };
  % \end{tikzpicture}
  \begin{columns}[b]
    \begin{column}{0.33\textwidth}
      \begin{figure}
        \begin{tikzpicture}
          \node[draw,circle] (A) {$A$}
          child {edge from parent[draw=none]}
          child {node[draw,circle] (B) {$B$} edge from parent[dashed]
            child {node[draw,circle,solid] (C) {$C$} edge from parent[dashed]
              child {node[draw,rectangle,solid] {$1$} edge from parent[solid]}
              child {node[draw,rectangle,solid] (0) {$0$}}
            }
            child {edge from parent[draw=none]}
          };
          \draw (A) -- (C);
          \draw (B) -- (0);
        \end{tikzpicture}
        \caption{BDD}
      \end{figure}
    \end{column}
    \begin{column}{0.34\textwidth}
      \begin{figure}
        \begin{tikzpicture}
          \node[draw,circle] {$\land$}
          child {node[draw,circle] {$\lor$}
            child {node[draw,circle] (parent) {$\land$}
              child {node[draw,rectangle] {$B$}}
              child {edge from parent[draw=none]}
            }
            child {node[draw,circle] {$\land$}
              child {node[draw,circle] {$\lor$}
                child {node[draw,rectangle] (A) {$A$}}
                child {node[draw,rectangle] {$\neg A$}}
              }
              child {node[draw,rectangle] {$\neg B$}}
            }
          }
          child {node[draw,rectangle] {$C$}};
          \draw (parent) -- (A);
        \end{tikzpicture}
        \caption{d-DNNF}
      \end{figure}
    \end{column}
    \begin{column}{0.33\textwidth}
      \begin{figure}
        \begin{tikzpicture}
          \tikzset{
            mysplit/.style={
              draw,
              rectangle,
              rectangle split,
              rectangle split horizontal,
              rectangle split parts=2
            }
          }
          \node[draw,circle] {$1$}
          child {node[mysplit] (bullet) {
              \nodepart{one} $\neg A$
              \nodepart{two}
            }
            child {node[draw,circle] (3) {$3$} edge from parent[draw=none]
              child {node[mysplit] {
                  \nodepart{one} $\neg B$
                  \nodepart{two} $C$
                }
              }
              child {node[mysplit] {
                  \nodepart{one} $B$
                  \nodepart{two} $0$
                }
              }
            }
          }
          child {node[mysplit] {
              \nodepart{one} $A$
              \nodepart{two} $C$
            }};
          \draw[*-] let \p1 = (bullet.two), \p2 = (bullet.center) in ({\x1 + 2.5},{\y2 + 2}) -- (3);
        \end{tikzpicture}
        \caption{SDD}
      \end{figure}
    \end{column}
  \end{columns}
\end{frame}

\begin{frame}{How Many Programs Are Used to Test Algorithms?}
  \begin{columns}
    \begin{column}{0.5\textwidth}
      \pause
      \fbox{
        \begin{tikzpicture}
          \node[inner sep = 0pt] (a) {\includegraphics[width=\textwidth]{inference3.png}};
          \node[anchor=center] at (a.center) {\Huge\alert{4}};
        \end{tikzpicture}
      }
      \pause
      \fbox{
        \begin{tikzpicture}
          \node[inner sep = 0pt] (a) {\includegraphics[width=\textwidth]{inference8.png}};
          \node[anchor=center] at (a.center) {\Huge\alert{3}};
        \end{tikzpicture}
      }
      \pause
      \fbox{
        \begin{tikzpicture}
          \node[inner sep = 0pt] (a) {\includegraphics[width=\textwidth]{inference7.png}};
          \node[anchor=center] at (a.center) {\Huge\alert{1}};
        \end{tikzpicture}
      }
    \end{column}
    \begin{column}{0.5\textwidth}
      \pause
      \fbox{
        \begin{tikzpicture}
          \node[inner sep = 0pt] (a) {\includegraphics[width=\textwidth]{inference6.png}};
          \node[anchor=center] at (a.center) {\Huge\alert{1}};
        \end{tikzpicture}
      }
      \pause
      \fbox{
        \begin{tikzpicture}
          \node[inner sep = 0pt] (a) {\includegraphics[width=\textwidth]{inference2.png}};
          \node[anchor=center] at (a.center) {\Huge\alert{1}};
        \end{tikzpicture}
      }
      \pause
      \fbox{
        \begin{tikzpicture}
          \node[inner sep = 0pt] (a) {\includegraphics[width=\textwidth]{inference1.png}};
          \node[anchor=center] at (a.center) {\Huge\alert{2}};
        \end{tikzpicture}
      }
    \end{column}
  \end{columns}
\end{frame}

\begin{frame}{What Characterises a (Probabilistic) Logic Program?}
  \begin{columns}
    \hspace*{-0.7cm}\begin{column}{0.75\textwidth}
      \begin{empheq}[left =\onslide<6->{\color{color5}\empheqlbrace}]{equation}
        \begin{align*}
      \textcolor<5->{probability}{0.2} \prob &\textcolor<2->{predicate}{\mathtt{stress}}(\textcolor<3->{variable}{\mathsf{P}}) \ifff \textcolor<2->{predicate}{\mathtt{person}}(\textcolor<3->{variable}{\mathsf{P}}). \\
      \textcolor<5->{probability}{0.3} \prob &\textcolor<2->{predicate}{\mathtt{influences}}(\textcolor<3->{variable}{\mathsf{P}_1}, \textcolor<3->{variable}{\mathsf{P}_2}) \ifff \textcolor<2->{predicate}{\mathtt{friend}}(\textcolor<3->{variable}{\mathsf{P}_1}, \textcolor<3->{variable}{\mathsf{P}_2}). \\
      \textcolor<5->{probability}{0.1} \prob &\textcolor<2->{predicate}{\mathtt{cancer\_spont}}(\textcolor<3->{variable}{\mathsf{P}}) \ifff \textcolor<2->{predicate}{\mathtt{person}}(\textcolor<3->{variable}{\mathsf{P}}). \\
      \textcolor<5->{probability}{0.3} \prob &\textcolor<2->{predicate}{\mathtt{cancer\_smoke}}(\textcolor<3->{variable}{\mathsf{P}}) \ifff \textcolor<2->{predicate}{\mathtt{person}}(\textcolor<3->{variable}{\mathsf{P}}). \\
                                         &\textcolor<2->{predicate}{\mathtt{smokes}}(\textcolor<3->{variable}{\mathsf{X}}) \ifff \textcolor<2->{predicate}{\mathtt{stress}}(\textcolor<3->{variable}{\mathsf{X}}). \\
                                         &\textcolor<2->{predicate}{\mathtt{smokes}}(\textcolor<3->{variable}{\mathsf{X}}) \ifff \textcolor<2->{predicate}{\mathtt{smokes}}(\textcolor<3->{variable}{\mathsf{Y}}), \textcolor<2->{predicate}{\mathtt{influences}}(\textcolor<3->{variable}{\mathsf{Y}}, \textcolor<3->{variable}{\mathsf{X}}). \\
                                         &\textcolor<2->{predicate}{\mathtt{cancer}}(\textcolor<3->{variable}{\mathsf{P}}) \ifff \textcolor<2->{predicate}{\mathtt{cancer\_spont}}(\textcolor<3->{variable}{\mathsf{P}}). \\
                                         &\textcolor<2->{predicate}{\mathtt{cancer}}(\textcolor<3->{variable}{\mathsf{P}}) \ifff \tikz \coordinate (start);\textcolor<2->{predicate}{\mathtt{smokes}}(\textcolor<3->{variable}{\mathsf{P}}), \textcolor<2->{predicate}{\mathtt{cancer\_smoke}}(\textcolor<3->{variable}{\mathsf{P}})\tikz \coordinate (end);. \\
                                         &\textcolor<2->{predicate}{\mathtt{person}}(\textcolor<4->{constant}{\mathit{michelle}}). \\
                                         &\textcolor<2->{predicate}{\mathtt{person}}(\textcolor<4->{constant}{\mathit{timothy}}). \\
                                         &\textcolor<2->{predicate}{\mathtt{friend}}(\textcolor<4->{constant}{\mathit{timothy}}, \textcolor<4->{constant}{\mathit{michelle}}).
        \end{align*}
      \end{empheq}
    \end{column}
    \begin{column}{0.25\textwidth}
      \begin{itemize}
      \item[\textcolor{predicate}{\textbullet}]<2-> predicates, arities
      \item[\textcolor{variable}{\textbullet}]<3-> variables
      \item[\textcolor{constant}{\textbullet}]<4-> constants
      \item[\textcolor{probability}{\textbullet}]<5-> probabilities
      \item[\textcolor{color5}{\textbullet}]<6-> length
      \item[\textcolor{color6}{\textbullet}]<7-> complexity
      \end{itemize}
    \end{column}
  \end{columns}
  \onslide<7->{
    \begin{tikzpicture}[overlay]
      \draw [decorate,decoration={brace,amplitude=10pt,mirror},color=color6] (start) -- (end);
    \end{tikzpicture}
  }
\end{frame}

% TODO: describe clauses as trees (showing an example of a clause)
% TODO: describe the rest of the model
% TODO: add a link to GitHub at the end

\begin{frame}{Scalability}
  \centering
  \input{impact.tex}
\end{frame}

\begin{frame}{Properties of Programs vs. Inference Algorithms}
  \centering
  \input{line_plots.tex}
\end{frame}

\begin{frame}{Properties of Programs vs. Inference Algorithms}
  \centering
  \input{../paper/bars.tex}
\end{frame}

% ===============================================================

\begin{frame}{Overview}
  \begin{block}{General parameters}
    \begin{itemize}
    \item maximum number of solutions
    \item \texttt{maxNumNodes} (in the tree representation of a clause)
    \item list of predicates with their variables
    \item maximum number of clauses
    \item option to forbid all cycles or just negative cycles
    \item list of probabilities that are randomly assigned to clauses: $\{ 0.1,
      0.2, \dots, 0.9, 1, 1, 1, 1, 1, 1 \}$
    \end{itemize}
  \end{block}
  \begin{block}{Decision variables}
    \begin{itemize}
    \item \texttt{IntVar[] clauseAssignments}: a predicate or disabled
    \item \texttt{Clause[] clauses}
    \end{itemize}
  \end{block}
\end{frame}

\begin{frame}{Constraints}
  \begin{block}{Each predicate should get at least one constraint}
    \begin{itemize}
    \item \texttt{numDisabledClauses}: defined by a \texttt{count} constraint
    \item $\texttt{numDistinctValues} = \begin{cases}
        \texttt{numPredicates} + 1 & \text{if } \texttt{numDisabledValues} > 0 \\
        \texttt{numPredicates} & \text{otherwise.}
      \end{cases}$
      \begin{itemize}
      \item also constrained using the \texttt{nValues} constraint
      \end{itemize}
    \end{itemize}
  \end{block}
  \begin{block}{Miscellaneous}
    \begin{itemize}
    \item \texttt{clauseAssignments} are sorted.
    \item If $\texttt{clauseAssignments}[i-1] = \texttt{clauseAssignments}[i]$,
      \begin{itemize}
      \item then $\texttt{clause}[i-1] \preceq \texttt{clause}[i]$.
      \end{itemize}
    \end{itemize}
  \end{block}
\end{frame}

\begin{frame}{Clauses}
  \begin{block}{A clause is defined by...}
    \begin{itemize}
    \item \texttt{IntVar[] treeStructure}
      \begin{itemize}
      \item $\texttt{treeStructure}[i] = i$: the $i$-th node is a root.
      \item $\texttt{treeStructure}[i] = j$: the $i$-th node's parent is node $j$.
      \end{itemize}
    \item \texttt{IntVar[] treeValues}: $\neg$, $\land$, $\lor$, $\top$, and any
      predefined predicates with variables.
    \end{itemize}
  \end{block}
  \begin{block}{Auxiliary variables}
    \begin{itemize}
    \item $\texttt{numNodes}, \texttt{numTrees} \in \{ 1, \dots, \texttt{maxNumNodes} \}$
    \end{itemize}
  \end{block}
\end{frame}

\begin{frame}{Clause constraints}
  \begin{itemize}
  \item \texttt{treeStructure} represents \texttt{numTrees} trees.
  \item $\texttt{treeStructure}[0] = 0$
  \item $\texttt{numTrees} + \texttt{numNodes} = \texttt{maxNumNodes} + 1$
  \item \texttt{treeStructure} is sorted
  \item For $i = 0, \dots, \texttt{maxNumNodes} - 1$,
    \begin{itemize}
    \item If $\texttt{numNodes} \le i$,
    \item then $\texttt{treeStructure}[i] = i$ and $\texttt{treeValues}[i] = \top$,
    \item else $\texttt{treeStructure}[i] < \texttt{numNodes}$.
    \item has 0 children $\iff$ $\texttt{treeValues}[i]$ is a predicate
    \item has 1 child $\iff$ $\texttt{treeValues}[i] = \neg$
    \item has $>1$ child $\iff$ $\texttt{treeValues}[i] \in \{ \land, \lor \}$
    \item $\texttt{treeStructure}[i] \ne i \implies \texttt{treeValues}[i] \ne \top$
    \end{itemize}
  \item If the clause should be disabled, $\texttt{numNodes} = 1$ and
    $\texttt{treeValues}[0] = \top$.
  \end{itemize}
\end{frame}

\begin{frame}
  \begin{block}{Adjacency matrix representation}
    $A[i][j] = 0 \iff \nexists k: \texttt{clauseAssignments}[k] = j$ and $i
    \in \texttt{clauses}[k].\texttt{treeValues}$
  \end{block}
  \begin{block}{New constraints}
    \begin{itemize}
    \item No (negative) cycles
      \begin{itemize}
      \item No clever propagation, just entailment checking.
      \end{itemize}
    \item Independence. Propagation:
      \begin{itemize}
      \item Two types of dependencies: determined and
        one-undetermined-edge-away-from-being-determined.
      \item Look up the dependencies of both predicates. For each pair of
        matching dependencies:
        \begin{itemize}
        \item If both are determined, fail.
        \item If one is determined, the selected edge of the other must not
          exist.
        \end{itemize}
      \end{itemize}
    \item Conditional independence
      \begin{itemize}
      \item Same propagation, but with a `filter' that masks out the expression
        that the independence is conditioned on.
      \end{itemize}
    \end{itemize}
  \end{block}
\end{frame}

\end{document}